= Kubernetes Java Samples
:toc:
:toclevels: 3
:toc-placement!:

toc::[]

This project shows different recipes to run a Java EE application using Kubernetes.

== Kubernetes Concepts

Key concepts of Kubernetes are explained below:

. *Pods*: Collocated group of Docker containers that share an IP and storage volume
. *Service*: Single, stable name for a set of pods, also acts as load balancer
. *Replication Controller*: Manages the lifecycle of pods and ensures specified number are running
. *Labels*: Used to organize and select group of objects
. *etcd*: Distributed key-value store used to persist Kubernetes system state
. *Master*: Hosts cluster-level control services, including the API server, scheduler, and controller manager
. *Node*: Docker host running _kubelet_ (node agent) and proxy services
. *Kubelet*: It runs on each node in the cluster and is responsible for node level pod management.

.Kubernetes Architecture
image::images/kubernetes-architecture.png[]

== Initial setup

. Download Kubernetes from
  https://github.com/kubernetes/kubernetes/releases/download/v1.4.0/kubernetes.tar.gz and extract.
. Include `kubernetes/cluster` in `PATH`.
. Start Kubernetes using Amazon Web Services:

  NUM_NODES=2 NODE_SIZE=m3.medium KUBERNETES_PROVIDER=aws kube-up.sh

Detailed instructions: http://kubernetes.io/docs/getting-started-guides/aws/

== A Pod with One Container

This section will explain how to start a Pod with one Container. WildFly base Docker image will be used as the Container.

. Start a Pod with WildFly container:
+
[source, text]
----
kubectl.sh create -f wildfly-pod.yaml
pod "wildfly-pod" created
----
+
. Get status of the Pod:
+
[source, text]
----
kubectl.sh get -w po
NAME          READY     STATUS              RESTARTS   AGE
wildfly-pod   0/1       ContainerCreating   0          6s
NAME          READY     STATUS    RESTARTS   AGE
wildfly-pod   1/1       Running   0          34s
----
+
NOTE: Make sure to wait for the status to change to Running.
+
. Get complete details about the generated Pod (including IP address):
+
[source, text]
----
kubectl.sh describe po wildfly-pod
Name:   wildfly-pod
Namespace:  default
Node:   ip-172-20-0-111.us-west-2.compute.internal/172.20.0.111
Start Time: Wed, 28 Sep 2016 15:38:02 -0700
Labels:   name=wildfly
Status:   Running
IP:   10.244.2.4
Controllers:  <none>
Containers:
  wildfly-pod:
    Container ID: docker://cfba313f7ec2c85c3ec7ff62c529973a2042aeaa1ae07026eb98c503442d2953
    Image:    jboss/wildfly
    Image ID:   docker://sha256:4c99bd2cd264d8a1b4b68816736650ca0c3555726c482a16a43cddc4c61df99c
    Port:   8080/TCP
    Requests:
      cpu:    100m
    State:    Running
      Started:    Wed, 28 Sep 2016 15:38:35 -0700
    Ready:    True
    Restart Count:  0
    Volume Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-4e59z (ro)
    Environment Variables:  <none>
Conditions:
  Type    Status
  Initialized   True 
  Ready   True 
  PodScheduled  True 
Volumes:
  default-token-4e59z:
    Type: Secret (a volume populated by a Secret)
    SecretName: default-token-4e59z
QoS Class:  Burstable
Tolerations:  <none>
Events:
  FirstSeen LastSeen  Count From              SubobjectPath     Type    Reason    Message
  --------- --------  ----- ----              -------------     --------  ------    -------
  4m    4m    1 {default-scheduler }            Normal    Scheduled Successfully assigned wildfly-pod to ip-172-20-0-111.us-west-2.compute.internal
  4m    4m    1 {kubelet ip-172-20-0-111.us-west-2.compute.internal}  spec.containers{wildfly-pod}  Normal    Pulling   pulling image "jboss/wildfly"
  3m    3m    1 {kubelet ip-172-20-0-111.us-west-2.compute.internal}  spec.containers{wildfly-pod}  Normal    Pulled    Successfully pulled image "jboss/wildfly"
  3m    3m    1 {kubelet ip-172-20-0-111.us-west-2.compute.internal}  spec.containers{wildfly-pod}  Normal    Created   Created container with docker id cfba313f7ec2; Security:[seccomp=unconfined]
  3m    3m    1 {kubelet ip-172-20-0-111.us-west-2.compute.internal}  spec.containers{wildfly-pod}  Normal    Started   Started container with docker id cfba313f7ec2
----
+
. Check logs of the Pod:
+
[source, text]
----
kubectl.sh logs wildfly-pod
=========================================================================

  JBoss Bootstrap Environment

  JBOSS_HOME: /opt/jboss/wildfly

  JAVA: /usr/lib/jvm/java/bin/java

  JAVA_OPTS:  -server -Xms64m -Xmx512m -XX:MetaspaceSize=96M -XX:MaxMetaspaceSize=256m -Djava.net.preferIPv4Stack=true -Djboss.modules.system.pkgs=org.jboss.byteman -Djava.awt.headless=true

=========================================================================

22:38:35,844 INFO  [org.jboss.modules] (main) JBoss Modules version 1.5.2.Final
22:38:36,209 INFO  [org.jboss.msc] (main) JBoss MSC version 1.2.6.Final
22:38:36,295 INFO  [org.jboss.as] (MSC service thread 1-2) WFLYSRV0049: WildFly Full 10.1.0.Final (WildFly Core 2.2.0.Final) starting
22:38:38,367 INFO  [org.jboss.as.server] (Controller Boot Thread) WFLYSRV0039: Creating http management service using socket-binding (management-http)
22:38:38,388 INFO  [org.xnio] (MSC service thread 1-1) XNIO version 3.4.0.Final

. . .

22:38:40,788 INFO  [org.wildfly.extension.undertow] (MSC service thread 1-2) WFLYUT0006: Undertow HTTPS listener https listening on 0.0.0.0:8443
22:38:40,905 INFO  [org.jboss.ws.common.management] (MSC service thread 1-2) JBWS022052: Starting JBossWS 5.1.5.Final (Apache CXF 3.1.6) 
22:38:41,195 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:9990/management
22:38:41,197 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:9990
22:38:41,197 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: WildFly Full 10.1.0.Final (WildFly Core 2.2.0.Final) started in 5888ms - Started 331 of 577 services (393 services are lazy, passive or on-demand)
----
+
. Delete the Pod:
+
[source, text]
----
kubectl.sh delete -f wildfly-pod.yaml
pod "wildfly-pod" deleted
----

== A Replication Controller with Two Replicas of a Pod

This section will explain how to start a https://github.com/kubernetes/kubernetes/blob/master/docs/user-guide/replication-controller.md[Replication Controller] with two replicas of a Pod. Each Pod will have one WildFly container.

. Start a Replication Controller that has two replicas of a pod, each with a WildFly container:
+
[source, text]
----
kubectl.sh create -f wildfly-rc.yaml
----
. Get status of the Pods:
+
[source, text]
----
kubectl.sh get -w po
NAME               READY     STATUS              RESTARTS   AGE
wildfly-rc-iv1o6   0/1       ContainerCreating   0          3s
wildfly-rc-lbcyq   0/1       ContainerCreating   0          3s
NAME               READY     STATUS    RESTARTS   AGE
wildfly-rc-iv1o6   1/1       Running   0          3s
wildfly-rc-lbcyq   1/1       Running   0         36s
----
+
NOTE: Make sure to wait for the status to change to Running.
+
Note down name of the Pods as "`wildfly-rc-bgtkg`" and "`wildfly-rc-l8fqv`".
+
. Get status of the Replication Controller:
+
[source, text]
----
kubectl.sh get rc
NAME         DESIRED   CURRENT   READY     AGE
wildfly-rc   2         2         2         55s
----
+
If multiple Replication Controllers are running then you can query for this specific one using the label:
+
[source, text]
----
kubectl.sh get rc -l name=wildfly
NAME         DESIRED   CURRENT   READY     AGE
wildfly-rc   2         2         2         1m
----

=== Rescheduling Pods

Replication Controller ensures that specified number of pod "`replicas`" are running at any one time. If there are too many, the replication controller kills some pods. If there are too few, it starts more.

Lets start a Replication Controller with two replicas of a pod. Delete a Pod and see how a new Pod is automatically rescheduled.

. Get pods:
+
[source, text]
----
kubectl.sh get pods
NAME               READY     STATUS    RESTARTS   AGE
wildfly-rc-iv1o6   1/1       Running   0          2m
wildfly-rc-lbcyq   1/1       Running   0          2m
----
+
. Delete a pod:
+
[source, text]
----
kubectl.sh delete pod/wildfly-rc-iv1o6
pod "wildfly-rc-iv1o6" deleted
----
+
. Get pods:
+
[source, text]
----
kubectl.sh get pods
NAME               READY     STATUS    RESTARTS   AGE
wildfly-rc-lbcyq   1/1       Running   0          3m
wildfly-rc-z3wg3   1/1       Running   0          6s
----
+
See a new pod is now created.

=== Scaling Pods

Replication Controller allows dynamic scaling up and down of Pods.

. Scale up the number of Pods:
+
[source, text]
----
kubectl.sh scale --replicas=3 rc wildfly-rc
scaled
----
+
. Check pods:
+
[source, text]
----
kubectl.sh get -w pods
NAME               READY     STATUS              RESTARTS   AGE
wildfly-rc-htfj2   1/1       Running             0          1m
wildfly-rc-oq97h   0/1       ContainerCreating   0          26s
wildfly-rc-z3wg3   1/1       Running             0          3m
NAME               READY     STATUS    RESTARTS   AGE
wildfly-rc-oq97h   1/1       Running   0          41s
----
+
Notice a new Pod with the name "`wildfly-rc-oq97h`" is created.
+
. Check RC:
+
[source, text]
----
kubectl.sh get rc
NAME         DESIRED   CURRENT   READY     AGE
wildfly-rc   3         3         3         7m
----
+
. Scale down the number of Pods:
+
[source, text]
----
kubectl.sh scale --replicas=1 rc wildfly-rc
scaled
----
+
. Check RC:
+
[source, text]
----
kubectl.sh get rc
NAME         DESIRED   CURRENT   READY     AGE
wildfly-rc   1         1         1         8m
----
+
. Check pods:
+
[source, text]
----
kubectl.sh get pods
NAME               READY     STATUS    RESTARTS   AGE
wildfly-rc-z3wg3   1/1       Running   0          5m
----
+
Notice only one Pod is running now.

=== Rolling Updates

https://github.com/arun-gupta/kubernetes-java-sample/tree/master/rolling-update

=== Multiple Release Tracks

PR for https://github.com/arun-gupta/kubernetes-java-sample/issues/2

=== Delete the Replication Controller

Finally, delete the Replication Controller:

[source, text]
----
kubectl.sh delete -f wildfly-rc.yaml
replicationcontroller "wildfly-rc" deleted
----

== Java EE Application deployed in a Pod with one Container (WildFly + H2 in-memory database)

This section will show how to deploy a Java EE application in a Pod with one Container. WildFly, with an in-memory H2 database, will be used as the container.

. Create Java EE 7 sample application Replication Controller:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh create -f ~/workspaces/kubernetes-java-sample/javaee7-hol.yaml
replicationcontrollers/javaee7-hol
----
+
. Get status of the Pod:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh get -w po
NAME                READY     STATUS    RESTARTS   AGE
javaee7-hol-kt6bw   0/1       Pending   0          3s
javaee7-hol-kt6bw   0/1       Pending   0          5s
javaee7-hol-kt6bw   0/1       Running   0         7s
javaee7-hol-kt6bw   1/1       Running   0         15s
----
+
NOTE: Make sure to wait for the status to change to Running.
+
. Get status of the Replication Controller:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh get rc
CONTROLLER    CONTAINER(S)   IMAGE(S)                SELECTOR           REPLICAS
javaee7-hol   master         arungupta/javaee7-hol   name=javaee7-hol   1
----
+
. Find IP address of the pod as:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh get -o template po javaee7-hol-kt6bw --template={{.status.podIP}}
----

+
. As mentioned earlier, Pod's IP address is accessible only inside the cluster. Login to the minion to access application's main page hosted by the containers:
+
[source, text]
----
kubernetes> vagrant ssh minion-1
Last login: Tue Jul 14 21:35:12 2015 from 10.0.2.2
[vagrant@kubernetes-minion-1 ~]$ curl http://10.246.1.104:8080/movieplex7/
<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html>
 ...
</html>
----
+
. Check logs of the Pod using the pod's name:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh logs javaee7-hol-kt6bw
W0715 10:07:53.235698   14344 cmd.go:149] log is DEPRECATED and will be removed in a future version. Use logs instead.
=========================================================================

  JBoss Bootstrap Environment

  JBOSS_HOME: /opt/jboss/wildfly

  JAVA: /usr/lib/jvm/java/bin/java

. . .

17:03:12,322 INFO  [org.wildfly.extension.undertow] (ServerService Thread Pool -- 64) WFLYUT0021: Registered web context: /movieplex7
17:03:12,369 INFO  [org.jboss.as.server] (ServerService Thread Pool -- 37) WFLYSRV0010: Deployed "movieplex7-1.0-SNAPSHOT.war" (runtime-name : "movieplex7-1.0-SNAPSHOT.war")
17:03:12,515 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0060: Http management interface listening on http://127.0.0.1:9990/management
17:03:12,516 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0051: Admin console listening on http://127.0.0.1:9990
17:03:12,516 INFO  [org.jboss.as] (Controller Boot Thread) WFLYSRV0025: WildFly Full 9.0.0.Final (WildFly Core 1.0.0.Final) started in 11951ms - Started 437 of 607 services (233 services are lazy, passive or on-demand)
----

=== Access the Application on Host

. `javaee7-hol.yaml` configuration file also exposes the `hostPort` on 8080. This allows port 8080 exposed by container to be forwarded at the port 8080 of the host.
+
NOTE: It is not recommended to publish `hostPort` as other Pods may try to use that port as well, and this will cause contention.
+
Get IP address of the host as:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh get -o=wide po
NAME                READY     STATUS    RESTARTS   AGE       NODE
javaee7-hol-kt6bw   1/1       Running   0          8m        10.245.1.3
----
+
. Access the application on host as:
+
[source, text]
----
kubernetes> curl http://10.245.1.3:8080/movieplex7/
<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html>
<!-- 
/*

. . .

            <div id="content" class="left_content">
                Showing 20 movies in 7 theaters!
            
            </div>
        </div></body>

</html>
----

=== Delete the Replication Controller

. Delete the Replication Controller:

[source, text]
----
kubernetes> ./cluster/kubectl.sh delete -f ~/workspaces/kubernetes-java-sample/javaee7-hol.yaml
replicationcontrollers/javaee7-hol
----

== Kubernetes Service

Pods are ephemeral. IP address assigned to a Pod cannot be relied upon. Kubernetes, Replication Controller in particular, create and destroy Pods dynamically. A _consumer_ Pod cannot rely upon the IP address of a _producer_ Pod.

https://github.com/kubernetes/kubernetes/blob/master/docs/user-guide/services.md[Kubernetes Service] is an abstraction which defines a set of logical Pods. The set of Pods targeted by a Service are determined by labels associated with the Pods.

This section will show how to run a WildFly and MySQL containers in separate Pods. WildFly Pod will talk to the MySQL Pod using a Service.

.Kubernetes Service
image::images/kubernetes-service.png[]

The order of Service and the targeted Pods does not matter. However Service needs to be started before any other Pods consuming the Service are started.

. Start MySQL Pod:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh create -f ~/workspaces/kubernetes-java-sample/app-mysql-pod.yaml 
pods/mysql-pod
----
+
. Get status of the Pod:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh get -w po
NAME        READY     STATUS    RESTARTS   AGE
mysql-pod   0/1       Pending   0          4s
mysql-pod   0/1       Running   0          44s
mysql-pod   1/1       Running   0          44s
----
+
. Start MySQL Service:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh create -f ~/workspaces/kubernetes-java-sample/app-mysql-service.yaml
services/mysql-service
----
+
. Get status of the Service:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh get -w se
NAME            LABELS                                    SELECTOR                                IP(S)          PORT(S)
kubernetes      component#apiserver,provider=kubernetes   <none>                                  10.247.0.1     443/TCP
mysql-service   context=docker-k8s-lab,name=mysql-pod     context=docker-k8s-lab,name=mysql-pod   10.247.63.43   3306/TCP
----
+
If multiple services are running, pods status can be narrowed by specifying labels:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh  get -w po -l context=docker-k8s-lab,name=mysql-pod
NAME        READY     STATUS    RESTARTS   AGE
mysql-pod   1/1       Running   0          4m
----
+
This is also the selector label used by Service to target Pods.
+
When a Service is run on a node, the kubelet adds a set of environment variables for each active Service. It supports both Docker links compatible variables and simpler `{SVCNAME}_SERVICE_HOST` and `{SVCNAME}_SERVICE_PORT` variables, where the Service name is upper-cased and dashes are converted to underscores.
+
Our service name is "`mysql-service`" and so `MYSQL_SERVICE_SERVICE_HOST` and `MYSQL_SERVICE_SERVICE_PORT` variables are available to other pods.
+
. Start WildFly Replication Controller:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh create -f ~/workspaces/kubernetes-java-sample/app-wildfly-rc.yaml
replicationcontrollers/wildfly-rc
----
+
. Check the status of Pod inside Replication Controller:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh get po
NAME               READY     STATUS    RESTARTS   AGE
mysql-pod          1/1       Running   0          1h
wildfly-rc-w2kk5   1/1       Running   0          6m
----
+
. Get IP address of the Pod:
+
[source, text]
----
kubernetes> ./cluster/kubectl.sh get -o template po wildfly-rc-w2kk5 --template={{.status.podIP}}
10.246.1.23
----
+
. Log in to minion and access the application:
+
[source, text]
----
kubernetes> vagrant ssh minion-1
Last login: Thu Jul 16 00:24:36 2015 from 10.0.2.2
[vagrant@kubernetes-minion-1 ~]$ curl http://10.246.1.23:8080/employees/resources/employees/
<?xml version="1.0" encoding="UTF-8" standalone="yes"?><collection><employee><id>1</id><name>Penny</name></employee><employee><id>2</id><name>Sheldon</name></employee><employee><id>3</id><name>Amy</name></employee><employee><id>4</id><name>Leonard</name></employee><employee><id>5</id><name>Bernadette</name></employee><employee><id>6</id><name>Raj</name></employee><employee><id>7</id><name>Howard</name></employee><employee><id>8</id><name>Priya</name></employee></collection>
----

== Kubernetes Application

Kubernetes allow multiple resources to be specified in a single configuration file. This allows to create a "`Kubernetes Application`" that can consists of multiple resources easily.

Previous section showed how to deploy the Java EE application using multiple configuration files. This application can be delpoyed using a single configuration file as well.

. Start the application using the configuration file:
+
[source, yaml]
....
apiVersion: v1
kind: Pod
metadata:
  name: mysql-pod
  labels:
    name: mysql-pod
    context: docker-k8s-lab
spec:
  containers:
    -
      name: mysql
      image: mysql:latest
      env:
        -
          name: "MYSQL_USER"
          value: "mysql"
        -
          name: "MYSQL_PASSWORD"
          value: "mysql"
        -
          name: "MYSQL_DATABASE"
          value: "sample"
        -
          name: "MYSQL_ROOT_PASSWORD"
          value: "supersecret"
      ports:
        -
          containerPort: 3306
----
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  labels:
    name: mysql-pod
    context: docker-k8s-lab
spec:
  ports:
    # the port that this service should serve on
    - port: 3306
  # label keys and values that must match in order to receive traffic for this service
  selector:
    name: mysql-pod
    context: docker-k8s-lab
----
apiVersion: v1
kind: ReplicationController
metadata:
  name: wildfly-rc
  labels:
    name: wildfly
    context: docker-k8s-lab
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: wildfly
    spec:
      containers:
      - name: wildfly-rc-pod
        image: arungupta/wildfly-mysql-javaee7:k8s
        ports:
        - containerPort: 8080
....
+
Notice that each section, one each for MySQL Pod, MySQL Service, and WildFly Replication Controller, is separated by `----`.
+
. Start the application:
+
[source, text]
----
./cluster/kubectl.sh create -f ~/workspaces/kubernetes-java-sample/app.yaml
pods/mysql-pod
services/mysql-service
replicationcontrollers/wildfly-rc
----
+
. Application can accessed by logging into minion as explained in the previous section.

== Router front-ending the Service

TODO

== Kubernetes Volumes

http://kubernetes.io/v1.0/docs/user-guide/volumes.html

== Kubernetes Application Health Checks

http://kubernetes.io/v1.0/docs/user-guide/walkthrough/k8s201.html#health-checking

Kubernetes cluster checks if the container process is still running, and if not, the container process is restarted. This basic level of health checking is already enabled for all containers running in the Kubernetes cluster. This health check is performed by Kubelet.

In addition, it also enables user implemented application health checks. These checks are performed by the Kubernetes cluster to ensure that the application is running "`correctly`" provided by the application.

Currently there are three types of application health checks.

. HTTP Health Checks
. Container Exec
. TCP Socket

=== Kubernetes HTTP Health Check

=== Kubernetes Container Exec Health Check

=== Kubernetes TCP Socket Health Check

== OpenShift

http://blog.arungupta.me/openshift-v3-getting-started-javaee7-wildfly-mysql/

== Fabric 8

=== Console

Allows to package and deploy application using a Console

=== Visualization of resources

=== Maven plugin to generate JSON for your WAR file

https://github.com/arun-gupta/kubernetes-java-sample/tree/master/maven

=== Deploy application to Kubernetes

https://github.com/arun-gupta/kubernetes-java-sample/tree/master/maven

